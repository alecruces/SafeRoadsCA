---
title: |
  | \vspace{5cm} \LARGE Fatalities in car accidents, a case of study in Canada
author: "José Chacón, Alejandra Cruces, Mario Tapia"
date: "2023-07-16"

output: 
  bookdown::pdf_document2:
      number_sections: true
      extra_dependencies: "subfig"
      toc: no
      
editor_options: 
  markdown: 
    wrap: 72
    
---

\newpage
```{=latex}
\setcounter{tocdepth}{4}
\tableofcontents
```
\newpage


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pathfile = "C:/Users/alecr/OneDrive/Escritorio/Master Data Science/Statistical Learning B/Proyect"
setwd(pathfile)

#Libraries
library(ggplot2)
library(dplyr)
library(ROSE)
library(stringr)
library(MASS)
library(caret)
library(glmnet)
library(ROCR)
library(rcompanion)
library(reshape)
library(stringr)
library(MuMIn)
library(modelsummary)
library(pROC)
library(knitr)
library(rmarkdown)
library(class)
library(oddsratio)
library(scales)
library(knitr)
library(kableExtra)
wrap_10 <- wrap_format(10)
require(gridExtra)
library(magick)

#Format for the graphs
My_Theme = theme(
  axis.title.x = element_text(size = 16),
  axis.text.x = element_text(size = 14),
  axis.title.y = element_text(size = 16),
  axis.text.y = element_text(size = 14))

My_Theme2 = theme(
  axis.title.x = element_text(size = 16),
  axis.text.x = element_text(size = 12),
  axis.title.y = element_text(size = 16),
  axis.text.y = element_text(size = 12))
```

# Introduction

This report analyze and predict car accidents in Canada based
on a data set from 1994 to 2004. The data set contained information
about the date, time, weather, road conditions, vehicle type, driver
age, and injury severity of each accident among others. The project
involved several steps, such as data cleaning and filtering, exploratory
data analysis, creation of new variables, undersampling of the majority
class, modeling with logistic regression and k-nearest neighbors, and
answering relevant data science questions. The main objective of the
project was to identify the most effective way to allocate resources for traffic 
surveillance in Canada, by identifying the factors that influence the likelihood and
severity of car accidents.
Additionally, we compare the performance of
two different machine learning algorithms for classification.

# Dataset

Our research uses a dataset of Canadian Car Accidents from 1994 to 2014,
which was constructed by Transport Canada. Transport Canada is a federal
institution from Canada that promotes safe, secure, efficient and
environmentally responsible transportation. The dataset is download from
Kaggle
([link](https://www.kaggle.com/datasets/tbsteal/canadian-car-accidents-19942014?select=NCDB_1999_to_2014.csv)).
The data set consists of 22 categorical variables and 5,860,405
observations. Each observation corresponds to a person who was involved
in a car crash. Therefore, one car crash can have multiple observations
depending on the number of people involved. The variables have different
numbers of categories, ranging from 2 to more than 30 (see Annex). The
variables can be grouped into three main categories: Collision level,
Vehicle level and Person level.

Our research aims to examine the factors that influence the occurrence
of fatalities in car crashes. For this purpose, we configure the data
set by car crash level. We also acknowledge that the data set is highly
imbalanced, as most of the car crashes do not result in fatalities. We
address this issue by using an undersampling technique that we will
explain later in this report.

# Exploratory Data Analysis

In this report, we will perform an Exploratory Dat Analysis on the data set of car accidents from Canada. We will clean and filter the data, explore the variables, distributions, trends and relationships in the data, as well as identify any potential issues or limitations. 

### Cleaning and Filtering of Data

We start by loading the data stored in a .csv file into the cars
variable, keeping the columns names as headers.

```{r load.data}
#Load Data
cars <- read.csv("NCDB_1999_to_2014.csv", header=TRUE)
```

```{r head1, echo = FALSE}
knitr::kable(head(cars[1:7]), "latex", align = "c", caption = "Head of the Dataset (columns 1 to 7)")%>%
  kable_styling(font_size = 7, latex_options = "HOLD_position")
```

```{r head2, echo = FALSE}
knitr::kable(head(cars[8:14]), "latex", align = "c", caption = "Head of the Dataset (columns 8 to 14)")%>%
  kable_styling(font_size = 7, latex_options = "HOLD_position")
```

```{r head3, echo = FALSE}
knitr::kable(head(cars[15:22]), "latex", align = "c", caption = "Head of the Dataset (columns 15 to 22)")%>%
  kable_styling(font_size = 7, latex_options = "HOLD_position")
```

The tables \@ref(tab:head1), \@ref(tab:head2) and \@ref(tab:head3) show
that most of the variables are character type, except for Collision
severity (C_SEV), which is categorical, and Year (C_YEAR), which is
numerical. Hence, we will treat all the variables as categorical in our
analysis, as explained in the subsequent sections. A detailed
description of each variable is given in the Annex. We will also examine
each level of each variable in depth, since there are many levels. The
Exploratory Data Analysis section will present the categories of the
variables more clearly. We should note that some values such as UU, QQ and XX
indicate missing information.

```{r summary, eval=FALSE, include=FALSE}
#We don't show this part because all the variable are categorical and is too much information to show now. We will
output <-summary(cars)
print(output)
```

### Removing missing values

Before exploring the dataset, we checked if there were any null values
across its columns.

```{r removemissing}
na_count <-sapply(cars, function(y) sum(is.na(y)))
print(na_count)
```

The last chunk of code returned zero null values in the dataset. As
there could also be null values encoded as blank spaces, we identified 3
rows whose values were empty under column C_VEHS (Number of vehicles
involved in collision).

```{r removemissing2}
#Evaluating blank space
na_count <-sapply(cars, function(y) sum(y == ""))
print(na_count)
```

It could be possible that there is corrupted data in these 3 rows, so we
analyzed them before taking any action.

```{r removemissing3}
cars[cars$C_VEHS == "",]
```

As we mentioned before, there are special categorical variables assigned
to accidents where certain information is unknown or the data was not
provided by the jurisdiction. These 3 rows included many of these
special values, so clearly the accident data was collected although
having missing important information.

So it's safe to not consider these 3 rows.

```{r removemissing4}
cars = cars %>% filter(C_VEHS != "")
```

About these special categorical values, while it makes sense that the
data were tagged with them for historical purposes, for our research
they are missing data so they don't add any value.

These values are the following:

```         
* U/UU/UUUU: Unknown,
* NN/NNNN: Data element is not applicable,
* QQ: Choice is other than the preceeding values,
* XXXX: Jurisdiction does not provide this data element.
```

So we updated the dataframe in order to not consider rows that include
these values, with the exception of C_WTHR and C_CONF where the value QQ can be of interest for the study.

```{r replacemissing}
cars = cars %>% filter(C_YEAR != 'U' & C_YEAR != 'UU' &
                    C_MNTH != 'U' & C_MNTH != 'UU' &
                      C_WDAY != 'U' & C_WDAY != 'UU' &
                      C_HOUR != 'U' & C_HOUR != 'UU' &
                      C_VEHS != 'U' & C_VEHS != 'UU' &
                      C_CONF != 'U' & C_CONF != 'UU' &
                      C_RCFG != 'U' & C_RCFG != 'UU' &
                      C_RCFG != 'QQ' &
                      C_MNTH != 'U' & C_MNTH != 'UU' &
                      C_WTHR != 'U' & C_WTHR != 'UU' &
                      C_RSUR != 'U' & C_RSUR != 'UU' &
                      C_RALN != 'U' & C_RALN != 'UU' &
                      C_RALN != 'Q' &
                      C_TRAF != 'U' & C_TRAF != 'UU' &
                      C_TRAF != 'QQ' &
                      P_PSN != 'NN' & P_PSN != 'QQ' &
                      V_ID != 'U' & V_ID != 'UU' &
                      V_TYPE != 'U' & V_TYPE != 'UU' &
                      V_YEAR != 'U' & V_YEAR != 'UU' & 
                      V_YEAR != 'NNNN' & V_YEAR != 'UUUU' &
                      V_YEAR != 'XXXX' &
                      P_ID != 'U' & P_ID != 'UU' &
                      P_SEX != 'U' & P_SEX != 'UU' &
                      P_AGE != 'U' & P_AGE != 'UU' & P_AGE != 'NN' &
                      P_PSN != 'U' & P_PSN != 'UU' &
                      P_ISEV != 'U' & P_ISEV != 'UU' &
                      P_ISEV != 'N' &
                      P_SAFE != 'U' & P_SAFE != 'UU' &
                      P_SAFE != 'NN' & P_SAFE != 'QQ' &
                      P_USER != 'U' & P_USER != 'UU')
```

After that, we checked the unique values for every column in the
dataframe in order to confirm there were no more of these special
categorical values.

```{r unique}
lapply(cars, unique,decreasing=FALSE)
```

```{r countfinaldataset, include=FALSE}
nrows.base.df <- nrow(cars)
```

After removing missing values, the dataset ended up having `r nrows.base.df`
rows, being reduced by approximately 2 million rows.

### Reducing the dataset to accident level

We decided to focus on the conditions at the time of the accident,
rather than the characteristics of each individual involved. This choice
was motivated by the greater number and relevance of the variables
related to the former perspective. These variables include factors such
as weather, week day, and month. To perform this analysis, we assigned a
unique ID to each accident based on these features, and then we removed
the duplicate entries by keeping only one accident per ID. After this,
we discarded the variables that were not related to the environmental
factors of the accidents.

```{r creating.collision.ID}
cars["ID"] <- paste(cars$C_YEAR, cars$C_MNTH, cars$C_WDAY, cars$C_HOUR, cars$C_SEV, 
                    cars$C_VEHS, cars$C_CONF, cars$C_RCFG, cars$C_WTHR, cars$C_RSUR, 
                    cars$C_RALN, cars$C_TRAF, sep = "")

#We will keep a copy of the original dataset
#in case that then we want to create additional features
cars_copy <- cars

#Keep one accident by ID, eliminate duplicate accidents
cars <- cars[!duplicated(cars[ , "ID"]), ]
```

## Exploring Data Distributions

To understand more our dataset and variables we carried out an
Exploratory Data Analysis divided in four parts:

1.  Periodicity of accidents

An evaluation of how the number of accidents has
increased/decreased in the period 1999 - 2014 and then evaluate how
variables like day of the week, hour or seasonal factors could
influence it.

2.  Variables distribution

A general overview of how frequent some dataset variables values are
compared to the others values this variable could take.

3.  Differences between fatal and non-fatal accidents in variable
    distribution

An evaluation of which variable values could be most likely to
appear depending of the severity of the accident according to its
frequency in our dataset.

4.  Person level analysis

An exploration of some factors that could be related to a fatality
at a person level like the use of seatbelt or the age of a person.

### Periodicity of accidents {.unlisted .unnumbered}

-   By year (Figure \ref{fig:plotvars1}.\subref*{fig:plotvars1-1}): A decrease over the years is seen, this effect could be attributed to the result of public policies in favour of the improvement of road designs, road surfaces, traffic signs and vial education. Also, it could be attributed to the improvement of technology and security standard in cars.

-   By day of the week (Figure \ref{fig:plotvars1}.\subref*{fig:plotvars1-2}): Car accidents peaks on Friday, while decreasing over the weekend with a minimum on Sunday.

-   By hour (Figure \ref{fig:plotvars1}.\subref*{fig:plotvars1-3}): The peak time of cars accidents is during the afternoon between 15-17 pm.
    
- Grouping by day of the week and hour two things stand out (Figure \ref{fig:plotvars1}.\subref*{fig:plotvars1-4}):
    
    1.  The frequency of accidents occurring past midnight increases on
        Saturday and Sunday (left side of each plot)
    
    2.  During the weekdays (Monday - Friday) accidents in the morning are
        most likely to happen.

-   Grouping by month and day (Figures \ref{fig:plotvars1}.\subref*{fig:plotvars1-5}, \ref{fig:plotvars2} and \ref{fig:plotvars3}): The months with highest frequency of accidents are November, December and January which could mean there's a factor of seasonality involved, given that winter starts in December and prolongues until February.

-   Periodicity of fatal accidents by day of the week and hour (Figure \ref{fig:plotvars4}): The plot clearly shows that fatal accidents reach a peak on friday and specially during the weekend, not only for those that happens in the early morning but also for those in the afternoon.

```{r plotvars1, echo=FALSE, cache=FALSE, results=FALSE, warning=FALSE,  comment=FALSE, message= FALSE, eval =T,  fig.cap = " Periodicity of accidents", fig.subcap=c("Year distribution", "Day of the week distribution","Hour distribution","Frequency of accidents by day of the week and hour","Frequency of accidents by month and day of the week"), out.width='.49\\linewidth', fig.dim = c(8, 6), fig.asp=1, fig.ncol = 2, fig.show="hold"}

ggplot(data = cars) +
  geom_bar(mapping = aes(x = C_YEAR), colour = "darkgrey" , fill = c("lightblue")) + 
  My_Theme

ggplot(data = cars) +
  geom_bar(mapping = aes(x = C_WDAY), colour = "darkgrey" , fill = c("lightblue")) +
  scale_x_discrete(labels=c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")) + 
  My_Theme


ggplot(data = cars) +
  geom_bar(mapping = aes(x = C_HOUR), colour = "darkgrey" , fill = c("lightblue"))+ 
  My_Theme

options(dplyr.summarise.inform = FALSE)

cars_day_hour_agg <- cars %>% group_by(C_WDAY, C_HOUR) %>% summarise(n = n())
early_morning <-  rep(c("darkgrey"),6)
morning <-  rep(c("#757575"),6)
afternoon <-  rep(c("gray27"),6)
evening <-  rep(c("black"),6)
bar_colors <- c(early_morning, morning, afternoon, evening)

ggplot(cars_day_hour_agg,aes(x = C_WDAY, y=n)) + 
    geom_bar(aes(fill = C_HOUR), 
             stat = "identity",position = "dodge",) +
    scale_fill_manual(values = bar_colors) +
    scale_x_discrete(labels=c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")) + 
    theme(legend.position = "none")+ 
  My_Theme

cars_month_day_agg <- cars %>% group_by(C_MNTH, C_WDAY) %>% summarise(n = n())

ggplot(cars_month_day_agg,aes(x = C_MNTH, y=n)) + 
    geom_bar(aes(fill = C_WDAY),stat = "identity",position = "dodge",) +
    scale_fill_grey(start=0.6, end=0.1) +
    scale_x_discrete(labels=c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))+ 
  My_Theme
```
```{r plotvars2, echo=FALSE, cache=FALSE, results=FALSE, warning=FALSE,  comment=FALSE, message= FALSE, eval =T,  fig.cap = "Day of the week distribution by season", fig.subcap=c("Winter", "Summer"), out.width='.49\\linewidth', fig.dim = c(8, 6), fig.asp=1, fig.ncol = 2, fig.show="hold"}

cars_winter <- cars %>% filter(C_MNTH %in% c("01","02","12"))

ggplot(data = cars_winter) +
  geom_bar(mapping = aes(x = C_WDAY), colour = "darkgrey" , fill = c("lightblue")) + 
  scale_x_discrete(labels=c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))+ 
  My_Theme

cars_summer <- cars %>% filter(C_MNTH %in% c("06","07","08"))

ggplot(data = cars_summer) +
  geom_bar(mapping = aes(x = C_WDAY), colour = "darkgrey" , fill = c("lightblue")) + 
  scale_x_discrete(labels=c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))+ 
  My_Theme

```
```{r plotvars3, echo=FALSE, cache=FALSE, results=FALSE, warning=FALSE,  comment=FALSE, message= FALSE, eval =T,  fig.cap = "Frequency of accidents by day of the week and hour", fig.subcap=c("Winter", "Summer"), out.width='.49\\linewidth', fig.dim = c(8, 6), fig.asp=1, fig.ncol = 2, fig.show="hold"}

cars_winter_day_hour_agg <- cars_winter %>% group_by(C_WDAY, C_HOUR) %>% summarise(n = n())
early_morning <-  rep(c("darkgrey"),6)
morning <-  rep(c("#757575"),6)
afternoon <-  rep(c("gray27"),6)
evening <-  rep(c("black"),6)
bar_colors <- c(early_morning, morning, afternoon, evening)

ggplot(cars_winter_day_hour_agg,aes(x = C_WDAY, y=n)) + 
    geom_bar(aes(fill = C_HOUR), 
             stat = "identity",position = "dodge",) +
    scale_fill_manual(values = bar_colors) +
    scale_x_discrete(labels=c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")) + 
    theme(legend.position = "none") + 
  My_Theme

cars_summer_day_hour_agg <- cars_summer %>% group_by(C_WDAY, C_HOUR) %>% summarise(n = n())
early_morning <-  rep(c("darkgrey"),6)
morning <-  rep(c("#757575"),6)
afternoon <-  rep(c("gray27"),6)
evening <-  rep(c("black"),6)
bar_colors <- c(early_morning, morning, afternoon, evening)

ggplot(cars_summer_day_hour_agg,aes(x = C_WDAY, y=n)) + 
    geom_bar(aes(fill = C_HOUR), 
             stat = "identity",position = "dodge",) +
    scale_fill_manual(values = bar_colors) +
    scale_x_discrete(labels=c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")) + 
    theme(legend.position = "none")+ 
  My_Theme

```

```{r filter_cars, echo=FALSE}
cars_ftl <- filter(cars, cars$C_SEV == 1)
cars_nftl <- filter(cars, cars$C_SEV == 2)
```

```{r plotvars4, echo=FALSE, cache=FALSE, results=FALSE, warning=FALSE,  comment=FALSE, message= FALSE, eval =T,  fig.cap = "Frequency of fatal accidents by day of the week and hour", out.width='.49\\linewidth', fig.dim = c(8, 6), fig.align="center", fig.show="hold"}

cars_day_hour_agg <- cars_ftl %>% group_by(C_WDAY, C_HOUR) %>% summarise(n = n())
early_morning <-  rep(c("darkgrey"),6)
morning <-  rep(c("#757575"),6)
afternoon <-  rep(c("gray27"),6)
evening <-  rep(c("black"),6)
bar_colors <- c(early_morning, morning, afternoon, evening)

ggplot(cars_day_hour_agg,aes(x = C_WDAY, y=n)) + 
    geom_bar(aes(fill = C_HOUR), 
             stat = "identity",position = "dodge",) +
    scale_fill_manual(values = bar_colors) +
    scale_x_discrete(labels=c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")) + 
    theme(legend.position = "none")+ 
  My_Theme

```
### Variables distribution

#### Collision level variables {.unlisted .unnumbered}

-   Severity of accident (Figure \ref{fig:plotvars5}.\subref*{fig:plotvars5-1}): As expected, in the dataset there are way more non-fatal accidents than
fatal ones.

-   Number of vehicles involved in collision (Figure \ref{fig:plotvars5}.\subref*{fig:plotvars5-2}): Because of the number of values that this variable could take, we consider the top 10 frequent values. The typical accident scenario is the one where two vehicles are involved.

- Collision configuration: Because there are 3 categories involving collisions, first we do a general overview of the frequencies (Figure \ref{fig:plotvars6}.\subref*{fig:plotvars6-1}) and then we focus in each category.

    The types of collisions with highest frequencies are:
    
    06: Other single vehicle collision configuration (Figure \ref{fig:plotvars6}.\subref*{fig:plotvars6-2})
    
    21: Rear-end collision (a vehicle crashes into the one in front of it) (Figure \ref{fig:plotvars6}.\subref*{fig:plotvars6-3})
    
    35: Right angle collision (vehicles traveling on perpendicular streets
    when one driver fails to yield the right of way to the other) (Figure \ref{fig:plotvars6}.\subref*{fig:plotvars6-4})

- Roadway configuration (Figure \ref{fig:plotvars7}.\subref*{fig:plotvars7-1}): The top-2 roadway configuration values are understandable given that
we've previously found that the most frequent collisions are the ones involving cars crashing into another car in front of them and ones involving vehicles traveling in perpendicular roads .

- Weather condition (Figure \ref{fig:plotvars7}.\subref*{fig:plotvars7-2}): Besides clear and sunny condition being the most frequent, we should
consider in the analysis when it's cloudy, raining or snowing.

```{r plotvars5, echo=FALSE, cache=FALSE, results=FALSE, warning=FALSE,  comment=FALSE, message= FALSE, eval =T,  fig.cap = "Collision level variables Part 1", fig.subcap=c("Severity of accidents distribution", "Number of vehicles involved in collision distribution"), out.width='.49\\linewidth', fig.dim = c(8, 6), fig.asp=1, fig.ncol = 2, fig.show="hold"}

ggplot(data = cars) +
  geom_bar(mapping = aes(x = factor(C_SEV)), colour = "darkgrey" , fill = c("lightblue", "#DD8888")) +
  scale_x_discrete(labels=c("Fatal", "Non-fatal")) +
  xlab("C_SEV")+ 
  My_Theme

top_10 <- names(sort(table(cars$C_VEHS), decreasing=TRUE)[1:10])
ggplot(data = cars) +
  geom_bar(mapping = aes(x = C_VEHS), colour = "darkgrey" , fill = c("lightblue"),na.rm=TRUE) + 
  xlim(top_10)+ 
  My_Theme

```
```{r plotvars6, echo=FALSE, cache=FALSE, results=FALSE, warning=FALSE,  comment=FALSE, message= FALSE, eval =T,  fig.cap = "Collision configuration by category", fig.subcap=c("Collision configuration distribution", "Collision involving single vehicle in motion", "Collision involving two vehicles in motion - same direction of travel", "Collision involving two vehicles in motion - different direction of travel"), out.width='.49\\linewidth', fig.dim = c(8, 6), fig.asp=1, fig.ncol = 2, fig.show="hold"}

ggplot(data=cars) +
    geom_bar(mapping = aes(x = C_CONF), colour = "darkgrey" , fill = c("lightblue"))

one_vh_vals <- c("01", "02", "03", "04", "05", "06")

lbl_cfg_one_vhs <- c("Hit a moving object", 
              "Hit a stationary object",
              "Ran off left shoulder", "Ran off right shoulder", "Rollover on roadway",
              "Other")


cars %>%   
  filter(cars$C_CONF %in% one_vh_vals) %>% 
  ggplot() +
    geom_bar(mapping = aes(x = C_CONF), colour = "darkgrey" , fill = c("lightblue"))
    scale_x_discrete(labels=wrap_10(lbl_cfg_one_vhs))
    
par(mar = c(4, 4, .1, .1))
two_vhs_vals <- c("21", "22", "23", "24", "25")

lbl_cfg_two_vhs_same_dir <- c("Rear-end collision", 
              "Side swipe",
              "Left turn conflict", "Right turn conflict", 
              "Other")


cars %>%   
  filter(cars$C_CONF %in% two_vhs_vals) %>% 
  ggplot() +
    geom_bar(mapping = aes(x = C_CONF), colour = "darkgrey" , fill = c("lightblue")) +
    scale_x_discrete(labels=wrap_10(lbl_cfg_two_vhs_same_dir))+ 
  My_Theme

two_vhs_vals <- c("31", "32", "33", "34", "35", "36", "41")

lbl_cfg_two_vhs_diff_dir <- c("Head-on collision", 
              "Approaching side-swipe",
              "Left turn across opposing traffic", "Right turn, including turning conflicts", 
              "Right angle collision", "Other",
              "Hit a parked motor vehicle")


cars %>%   
  filter(cars$C_CONF %in% two_vhs_vals) %>% 
  ggplot() +
    geom_bar(mapping = aes(x = C_CONF), colour = "darkgrey" , fill = c("lightblue")) +
    scale_x_discrete(labels=wrap_10(lbl_cfg_two_vhs_diff_dir))+ 
  My_Theme
```

```{r plotvars7, echo=FALSE, cache=FALSE, results=FALSE, warning=FALSE,  comment=FALSE, message= FALSE, eval =T,  fig.cap = "Collision level variables Part 2", fig.subcap=c("Roadway configuration distribution", "Weather condition distribution"), out.width='.49\\linewidth', fig.dim = c(8, 6), fig.asp=1, fig.ncol = 2, fig.show="hold"}

lbl_rcfg <- c("Non intersection", "At an intersection of at least two public roadways", "Intersection with parking lot entrance/exit, private driveway or laneway", "Railroad level crossing", "Bridge, overpass, viaduct", "Tunnel or underpass", "Passing or climbing lane", "Ramp", "Traffic circle", "Express lane of a freeway system", "Collector lane of a freeway system", "Transfer lane of a freeway system")

ggplot(data = cars) +
  geom_bar(mapping = aes(x = C_RCFG), colour = "darkgrey" , fill = c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_rcfg))

lbl_wthr <- c("Clear\nand\nsunny", "Overcast, cloudy", "Raining", "Snowing", "Freezing\nrain", "Visibility\nlimitation", "Strong\nwind")
ggplot(data = cars) +
  geom_bar(mapping = aes(x = C_WTHR), colour = "darkgrey" , fill = c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_wthr))

```

- Road surface (Figure \ref{fig:plotvars8}.\subref*{fig:plotvars7-1}): There's a seasonal factor involved with road surface with snow, wet and
icy characteristics being part of the most frequent values.

- Road alignment (Figure \ref{fig:plotvars8}.\subref*{fig:plotvars7-2}): Accidents with straight road alignment are more usual but roads with
gradient and curved characteristics are important to consider in
posterior analysis.

- Traffic control (Figure \ref{fig:plotvars8}.\subref*{fig:plotvars8-3}): The common case in the dataset is that accidents occur where no
traffic control is present.

```{r plotvars8, echo=FALSE, cache=FALSE, results=FALSE, warning=FALSE,  comment=FALSE, message= FALSE, eval =T,  fig.cap = "Collision level variables Part 3", fig.subcap=c("Road Surface distribution", "Road Alignment distribution","Traffic Control distribution"), out.width='.49\\linewidth', fig.dim = c(8, 6), fig.asp=1, fig.ncol = 2, fig.align='center', fig.show="hold"}

lbl_rsur <- c("Dry, normal", "Wet", "Snow", "Wet snow", "Icy", "Sand/gravel/dirt", "Muddy", "Oil", "Flooded")

ggplot(data = cars) +
  geom_bar(mapping = aes(x = C_RSUR), colour = "darkgrey" , fill = c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_rsur))

lbl_raln <- c("Straight and level", "Straight with gradient", "Curved and level", "Curved with gradient", "Top of hill or gradient", "Bottom of hill or gradient")

ggplot(data = cars) +
  geom_bar(mapping = aes(x = C_RALN), colour = "darkgrey" , fill = c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_raln))

lbl_traf <- c("Traffic signals fully operational", "Traffic signals in flashing mode", "Stop sign", 
              "Yield sign", "Warning sign", "Pedestrian crosswalk", "Police officer" , 
              "School guard, flagman", "School crossing", "Reduced speed zone", "No passing zone sign",
              "Markings on the road", "School bus stopped with school bus signal lights flashing", 
              "Railway crossing with signals, or signals and gates", 
              "Railway crossing with signs only", "Control device not specified", "No control present")

lbl_traf <- sapply(lbl_traf, wrap_10)
factor_traf <- factor(cars$C_TRAF,labels=lbl_traf)
top_seven <- names(sort(table(factor_traf), decreasing=TRUE)[1:7])


ggplot(data = cars) +
  geom_bar(mapping = aes(x = factor_traf), colour = "darkgrey" , fill = c("lightblue"),na.rm=TRUE) + 
  xlim(top_seven) +
  xlab("C_TRAF")+ 
  My_Theme

```
#### Vehicle level variables {.unlisted .unnumbered}

- Vehicle type (Figure \ref{fig:plotvars9}.\subref*{fig:plotvars9-1}): Light duty vehicles are by a large margin the most frequent vehicle
types involved in accidents.

- Vehicle model year (Figure \ref{fig:plotvars9}.\subref*{fig:plotvars9-2}): This variable on its own doesn't give us much clues about the
characteristics of an accident.

```{r plotvars9, echo=FALSE, cache=FALSE, results=FALSE, warning=FALSE,  comment=FALSE, message= FALSE, eval =T,  fig.cap = "Vehicle level variables", fig.subcap=c("Vehicle type distribution", "Vehicle model year distribution"), out.width='.49\\linewidth', fig.dim = c(8, 6), fig.asp=1, fig.ncol = 2, fig.align='center', fig.show="hold"}
lbl_v_type <- c("Light duty vehicle", "Cargo van", "Other trucks and vans",
                "Unit Trucks > 4536 KG", "Road tractor", "School bus", "Smaller school bus",
                "Urban\nand\nIntercity Bus", "Motorcycle and moped", 
                "Bicycle", "Purpose-built\nmotorhome",  "Fire engine",
                "Street car")
lbl_v_type <- sapply(lbl_v_type, wrap_10)
factor_vtype <- factor(cars_copy$V_TYPE,labels=lbl_v_type)
top_ten <- names(sort(table(factor_vtype), decreasing=TRUE)[1:10])

ggplot(data = cars_copy) +
  geom_bar(mapping = aes(x = factor_vtype), colour = "darkgrey" , fill = c("lightblue"),na.rm=TRUE) + 
  xlim(top_ten) +
  xlab("V_TYPE")+ 
  My_Theme2

ggplot(data = cars_copy) +
  geom_bar(mapping = aes(x = as.numeric(V_YEAR)), colour = "darkgrey" , fill = c("lightblue")) +
  xlab("V_YEAR")+ 
  My_Theme2

```
### Person level variables

- Person involved in the collision by gender (Figure \ref{fig:plotvars10}.\subref*{fig:plotvars10-1}): In the dataset, there are more males involved in an accident than
females.

- Person involved in the collision by age (Figure \ref{fig:plotvars10}.\subref*{fig:plotvars10-2}): In the dataset, the age range of 20-30 is the one more frequent to be
part of a car accident.

- Person involved in the collision position in the vehicle (Figure \ref{fig:plotvars11}): As expected, most of the positions distributions are from drivers.

-  Medical treatment for a person involved in an accident (Figure \ref{fig:plotvars12}.\subref*{fig:plotvars12-1}): People involved in a car accident are more likely to receive medical
treatment for injuries.

- Safety device used by a person involved in an accident (Figure \ref{fig:plotvars12}.\subref*{fig:plotvars12-2}): By a large margin, safety device was used.

- Road user class (Figure \ref{fig:plotvars13}) : There are more car accidents were there's a motor vehicle
driver/passenger affected than the ones where pedestrians are.

```{r plotvars10, echo=FALSE, cache=FALSE, results=FALSE, warning=FALSE,  comment=FALSE, message= FALSE, eval =T,  fig.cap = "Person level variables", fig.subcap=c("Person sex distribution", "Person age distribution"), out.width='.49\\linewidth', fig.dim = c(8, 6), fig.asp=1, fig.ncol = 2, fig.show="hold"}

ggplot(data = cars_copy) +
  geom_bar(mapping = aes(x = P_SEX), colour = "darkgrey" , fill = c("lightblue", "#DD8888"))+ 
  My_Theme

ggplot(data = cars_copy) +
  geom_bar(mapping = aes(x = as.numeric(P_AGE)), colour = "darkgrey" , fill = c("lightblue")) +
  xlab("P_AGE")+ 
  My_Theme

```

```{r plotvars11, echo=FALSE, cache=FALSE, results=FALSE, warning=FALSE,  comment=FALSE, message= FALSE, eval =T,  fig.cap = "Person position distribution", out.width='.49\\linewidth', fig.dim = c(14, 8), fig.asp=1, fig.ncol = 2, fig.align='center', fig.show="hold"}

lbl_p_psn = c("Driver", "1st Row center", "1st Row right outboard",
              "2nd Row left outboard", "2nd row center", "2nd row right outboard",
              "3rd row left outboard", "3rd row center", "3rd row right outboard", "Unknown", "On a lap", "Outside", "Pedestrian")
ggplot(data = cars_copy) +
  geom_bar(mapping = aes(x = P_PSN), colour = "darkgrey" , fill = c("lightblue")) + 
  scale_x_discrete(labels=wrap_10(lbl_p_psn)) + 
  My_Theme
```

```{r plotvars12, echo=FALSE, cache=FALSE, results=FALSE, warning=FALSE,  comment=FALSE, message= FALSE, eval =T,  fig.cap = "Person level variables Part 2", fig.subcap=c("Medical treatment required distribution", "Safety device used distribution"), out.width='.49\\linewidth', fig.dim = c(8, 6), fig.asp=1, fig.ncol = 2, fig.align='center', fig.show="hold"}

lbl_isev = c("No injury", "Injury", "Fatality")
ggplot(data = cars_copy) +
  geom_bar(mapping = aes(x = P_ISEV), colour = "darkgrey" , fill = c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_isev))+ 
  My_Theme

lbl_p_safe <- c("No safety device used or No child restraint used",
                "Safety device used or child restraint used",
                "Helmet worn",
                "Reflective clothing worn",
                "Both helmet and reflective clothing used",
                "Other safety device used",
                "No safety device equipped")
ggplot(data = cars_copy) +
  geom_bar(mapping = aes(x = P_SAFE), colour = "darkgrey" , fill = c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_p_safe))+ 
  My_Theme

```

```{r plotvars13, echo=FALSE, cache=FALSE, results=FALSE, warning=FALSE,  comment=FALSE, message= FALSE, eval =T,  fig.cap = "Road user class distribution", out.width='.49\\linewidth', fig.dim = c(8, 6), fig.align='center', fig.align='center', fig.show="hold"}

par(mar = c(4, 4, .1, .1))
lbl_p_user <- c("Motor Vehicle Driver", "Motor Vehicle Passenger", 
                "Pedestrian", "Bicyclist", "Motorcyclist")

ggplot(data = cars_copy) +
  geom_bar(mapping = aes(x = P_USER), colour = "darkgrey" , fill = c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_p_user)) + 
  My_Theme

```
### Differences between fatal and non-fatal accidents in variables distribution

- Day of the week (Figure \ref{fig:plotvars14}): While there's a decrease in the number of non-fatal accidents on
Saturday and Sunday, for fatal accidents, the quantity of those increases from Thursday to Saturday.

- Hour of the day (Figure \ref{fig:plotvars15}): Besides the fact that fatal accidents occur more frequently during early
morning, it's good to point out that there's an increase of accidents
taking place during 8-9am, probably because of people commuting to their
workplace.

```{r plotvars14, echo = FALSE, fig.cap='Weekday', fig.subcap=c('Non-fatal accidents', 'Fatal accidents'), out.width='.49\\linewidth', fig.asp=1, fig.ncol = 2,fig.show="hold", fig.dim = c(8, 6), fig.show="hold"}
ggplot(cars_nftl, aes(x = C_WDAY, fill = C_SEV)) + 
  geom_bar(colour = "darkgrey", fill=c("lightblue"))+ 
  My_Theme

ggplot(cars_ftl, aes(x = C_WDAY, fill = C_SEV)) + 
  geom_bar(colour = "darkgrey", fill=c("lightblue"))+ 
  My_Theme

```

```{r plotvars15, echo = FALSE, fig.cap='Hour of the day', fig.subcap=c('Non-fatal accidents', 'Fatal accidents'), out.width='.49\\linewidth', fig.dim = c(8, 6), fig.asp=1, fig.ncol = 2,fig.show="hold"}
ggplot(cars_nftl, aes(x = C_HOUR, fill = C_SEV)) + 
  geom_bar(colour = "darkgrey", fill=c("lightblue")) + 
  scale_x_discrete(breaks=c("00", "05", "10","15","20","23"))+ 
  My_Theme

ggplot(cars_ftl, aes(x = C_HOUR, fill = C_SEV)) + 
  geom_bar(colour = "darkgrey", fill=c("lightblue")) + 
    scale_x_discrete(breaks=c("00", "05", "10","15","20","23"))+ 
  My_Theme

```

- Weather condition (Figure \ref{fig:plotvars16}): There's not much of a difference compared to the general variable
distribution.

- Number of vehicles (Figure \ref{fig:plotvars17}): In fatal accidents the frequency of accidents involving one vehicle and those involving 2 are mostly the same.

- Roadway configuration (Figure \ref{fig:plotvars18}): In fatal accidents, accidents occurring in non-intersection of road are more frequent than those occurring in intersection of public roadways. While in non-fatal accidents, those two configuration share similar frequencies.
```{r plotvars16, echo = FALSE, fig.cap='Weather Condition', fig.subcap=c('Non-fatal accidents', 'Fatal accidents'), fig.dim = c(8, 6), out.width='.49\\linewidth', fig.asp=1, fig.ncol = 2,fig.show="hold"}
lbl_wthr <- c("Clear and sunny", "Overcast, cloudy", "Raining", "Snowing", "Freezing rain", "Visibility limitation", "Strong wind")

ggplot(cars_nftl, aes(x = C_WTHR, fill = C_SEV)) + 
  geom_bar(colour = "darkgrey", fill=c("lightblue"))+
  scale_x_discrete(labels=wrap_10(lbl_wthr))+ 
  My_Theme2

ggplot(cars_ftl, aes(x = C_WTHR, fill = C_SEV)) + 
  geom_bar(colour = "darkgrey", fill=c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_wthr))+ 
  My_Theme2

```

```{r plotvars17, echo = FALSE, fig.cap='Number of vehicles', fig.subcap=c('Non-fatal accidents', 'Fatal accidents'), fig.dim = c(8, 6), out.width='.49\\linewidth', fig.asp=1, fig.ncol = 2,fig.show="hold"}

top_10_a <- names(sort(table(cars_nftl$C_VEHS), decreasing=TRUE)[1:10])
top_10_b <- names(sort(table(cars_ftl$C_VEHS), decreasing=TRUE)[1:10])

ggplot(cars_nftl, aes(x = C_VEHS, fill = C_SEV)) + 
  geom_bar(colour = "darkgrey", fill=c("lightblue"), na.rm=TRUE)+
  xlim(top_10_a)+ 
  My_Theme

ggplot(cars_ftl, aes(x = C_VEHS, fill = C_SEV)) + 
  geom_bar(colour = "darkgrey", fill=c("lightblue"),na.rm=TRUE) +
  xlim(top_10_b)+ 
  My_Theme

```


- Road Surface (Figure \ref{fig:plotvars19}): There's not much of a difference compared to the general variable
distribution.
```{r plotvars18, echo = FALSE, fig.cap='Roadway Configuration', fig.subcap=c('Non-fatal accidents', 'Fatal accidents'), fig.dim = c(8, 6), out.width='.49\\linewidth', fig.asp=1, fig.ncol = 2,fig.show="hold"}
top5_vals <- c("01", "02", "03", "04", "05")

lbl_rcfg <- c("Non-\nintersection", "Intersection of public roadways", 
              "Intersection with parking lot private driveway or laneway",
              "Railroad level crossing", "Bridge, overpass, viaduct")

cars_nftl %>%   
  filter(C_RCFG %in% top5_vals) %>% 
  ggplot(aes(x = C_RCFG, fill = C_SEV)) + 
  geom_bar(colour = "darkgrey", fill=c("lightblue"), na.rm=TRUE)+
  scale_x_discrete(labels=wrap_10(lbl_rcfg))+ 
  My_Theme

cars_ftl %>%   
  filter(C_RCFG %in% top5_vals) %>% 
  ggplot(aes(x = C_RCFG, fill = C_SEV)) +
  geom_bar(colour = "darkgrey", fill=c("lightblue"), na.rm=TRUE) +
  scale_x_discrete(labels=wrap_10(lbl_rcfg))+ 
  My_Theme

```

```{r plotvars19, echo = FALSE, fig.cap='Road Surface',fig.subcap=c('Non-fatal accidents', 'Fatal accidents'), fig.dim = c(8, 6), out.width='.49\\linewidth', fig.asp=1, fig.ncol = 2,fig.show="hold"}
lbl_rsur <- c("Dry, normal", "Wet", "Snow", "Wet snow", "Icy", "Sand/\ngravel/\ndirt", "Muddy", "Oil", "Flooded")

ggplot(cars_nftl, aes(x = C_RSUR, fill = C_SEV)) + 
  geom_bar(colour = "darkgrey", fill=c("lightblue")) + 
  scale_x_discrete(labels=wrap_10(lbl_rsur))+ 
  My_Theme2

ggplot(cars_ftl, aes(x = C_RSUR, fill = C_SEV)) + 
  geom_bar(colour = "darkgrey", fill=c("lightblue")) + 
  scale_x_discrete(labels=wrap_10(lbl_rsur))+ 
  My_Theme2
```
- Road Alignment (Figure \ref{fig:plotvars20}): Fatalities occurs mainly in curved and level, and curved with gradient roads compared to non-fatalities accidents.
```{r plotvars20, echo = FALSE, fig.cap='Road Alignment', fig.subcap=c('Non-fatal accidents', 'Fatal accidents'), fig.dim = c(8, 6), out.width='.49\\linewidth', fig.asp=1, fig.ncol = 2,fig.show="hold"}
lbl_raln <- c("Straight and level", "Straight with gradient", "Curved and level", "Curved with gradient", "Top of hill or gradient", "Bottom of hill or gradient")

ggplot(cars_nftl, aes(x = C_RALN, fill = C_SEV)) + 
  geom_bar(colour = "darkgrey", fill=c("lightblue")) + 
  scale_x_discrete(labels=wrap_10(lbl_raln)) + 
  My_Theme2

ggplot(cars_ftl, aes(x = C_RALN, fill = C_SEV)) + 
  geom_bar(colour = "darkgrey", fill=c("lightblue")) + 
  scale_x_discrete(labels=wrap_10(lbl_raln))+ 
  My_Theme2
```
- Vehicle type (Figure \ref{fig:plotvars21}): There's not much of a difference compared to the general variable
distribution.

- Traffic control (Figure \ref{fig:plotvars22}): Fatal accidents are more likely to occur where no control is present. While in non-fatal accidents, there's a good portion of accidents
happening where traffic signs are located.
```{r veh_type, echo=FALSE}
cars_copy_ftl <- filter(cars_copy, cars_copy$C_SEV == 1)
cars_copy_nftl <- filter(cars_copy, cars_copy$C_SEV == 2)
```

```{r plotvars21, echo = FALSE, fig.cap='Vehicle Type', fig.subcap=c('Non-fatal accidents', 'Fatal accidents'), fig.dim = c(8, 6), out.width='.49\\linewidth', fig.asp=1, fig.ncol = 2,fig.show="hold"}
lbl_v_type <- c("Light duty vehicle", "Cargo van", "Other trucks and vans",
                "Unit Trucks > 4536 KG", "Road tractor", "School bus", "Smaller school bus",
                "Urban and Intercity Bus", "Motorcycle and moped", 
                "Bicycle", "Purpose-built motorhome",  "Fire engine",
                "Street car")
lbl_v_type <- sapply(lbl_v_type, wrap_10)
factor_vtype_nftl <- factor(cars_copy_nftl$V_TYPE,labels=lbl_v_type)
top_ten_nftl <- names(sort(table(factor_vtype_nftl), decreasing=TRUE)[1:10])

factor_vtype_ftl <- factor(cars_copy_ftl$V_TYPE,labels=lbl_v_type)
top_ten_ftl <- names(sort(table(factor_vtype_ftl), decreasing=TRUE)[1:10])


ggplot(cars_copy_nftl,  aes(x = V_TYPE, fill = C_SEV)) +
  geom_bar(mapping = aes(x = factor_vtype_nftl), colour = "darkgrey" , fill = c("lightblue"),na.rm=TRUE) + 
  xlim(top_ten_nftl) +
  xlab("V_TYPE")+ 
  My_Theme2


ggplot(cars_copy_ftl,  aes(x = V_TYPE, fill = C_SEV)) +
  geom_bar(mapping = aes(x = factor_vtype_ftl), colour = "darkgrey" , fill = c("lightblue"),na.rm=TRUE) + 
  xlim(top_ten_ftl) +
  xlab("V_TYPE")  + 
  My_Theme2

```

```{r plotvars22, echo = FALSE, fig.cap='Traffic Control', fig.subcap=c('Non-fatal accidents', 'Fatal accidents'), fig.dim = c(8, 6), out.width='.49\\linewidth', fig.asp=1, fig.ncol = 2,fig.show="hold"}
lbl_traf <- c("Traffic signals fully operational", "Traffic signals in flashing mode", "Stop sign", 
              "Yield sign", "Warning sign", "Pedestrian crosswalk", "Police officer" , 
              "School guard, flagman", "School crossing", "Reduced speed zone", "No passing zone sign",
              "Markings on the road", "School bus stopped with school bus signal lights flashing", 
              "Railway crossing with signals, or signals and gates", 
              "Railway crossing with signs only", "Control device not specified", "No control present")

lbl_traf2 <- c("Traffic signals fully operational", "Traffic signals in flashing mode", "Stop sign", 
              "Yield sign", "Warning sign", "Pedestrian crosswalk", "Police officer" , 
              "School guard, flagman","Reduced speed zone", "No passing zone sign",
              "Markings on the road", "School bus stopped with school bus signal lights flashing", 
              "Railway crossing with signals, or signals and gates", 
              "Railway crossing with signs only", "Control device not specified", "No control present")

lbl_traf <- sapply(lbl_traf, wrap_10)
lbl_traf2 <- sapply(lbl_traf2, wrap_10)

factor_traf_nftl <- factor(cars_nftl$C_TRAF,labels=lbl_traf)
top_seven_nftl <- names(sort(table(factor_traf_nftl), decreasing=TRUE)[1:7])
factor_traf_ftl <- factor(cars_ftl$C_TRAF,labels=lbl_traf2)
top_seven_ftl <- names(sort(table(factor_traf_ftl), decreasing=TRUE)[1:7])

ggplot(cars_nftl,  aes(x = C_TRAF, fill = C_SEV)) +
  geom_bar(mapping = aes(x = factor_traf_nftl), colour = "darkgrey" , fill = c("lightblue"),na.rm=TRUE) + 
  xlim(top_seven_nftl) +
  xlab("C_TRAF")+ 
  My_Theme

ggplot(cars_ftl,  aes(x = C_TRAF, fill = C_SEV)) +
  geom_bar(mapping = aes(x = factor_traf_ftl), colour = "darkgrey" , fill = c("lightblue"),na.rm=TRUE) + 
  xlim(top_seven_ftl) + 
  xlab("C_TRAF")+ 
  My_Theme

```
- Collision Configuration (Figure \ref{fig:plotvars23}): Here we notice a great difference between non-fatal and fatal accidents. While in non-fatal accidents the frequencies for the values that this
variable could take are similar to the ones found in the general variable distribution, this is not the case for fatal accidents. Head-on collisions are the most frequent case for fatal accidents, meaning that
could be a key factor for determining the severity of the accident.

- Road user class (Figure \ref{fig:plotvars24}): Severe accidents between a vehicle and a bicyclists are more likely to
end up in a fatality for the second.


```{r plotvars23, echo = FALSE, fig.cap='Collision Configuration', fig.subcap=c('Non-fatal accidents', 'Fatal accidents'), fig.dim = c(8, 6), out.width='.49\\linewidth', fig.asp=1, fig.ncol = 2,fig.show="hold"}
lbl_conf <- c("Hit a moving object", "Hit a stationary object", "Ran off left shoulder", 
  "Ran off right shoulder", "Rollover on roadway", "Other single vehicle collision", "Rear-end collision", "Side swipe",
  "Left turn conflict", "Right turn conflict", "Other two vehicle collision", "Head-on collision", "Approaching side-swipe",
  "Left turn across opposing traffic", "Right turn, including turning conflicts", "Right angle collision", 
  "Other two-vehicle collision - different direction of travel", "Hit a parked motor vehicle", "Other")

lbl_conf <- sapply(lbl_conf, wrap_10)

factor_conf_nftl <- factor(cars_nftl$C_CONF,labels=lbl_conf)
top_seven_nftl <- names(sort(table(factor_conf_nftl), decreasing=TRUE)[1:7])
factor_conf_ftl <- factor(cars_ftl$C_CONF,labels=lbl_conf)
top_seven_ftl <- names(sort(table(factor_conf_ftl), decreasing=TRUE)[1:7])

ggplot(cars_nftl,  aes(x = C_CONF, fill = C_SEV)) +
  geom_bar(mapping = aes(x = factor_conf_nftl), colour = "darkgrey" , fill = c("lightblue"),na.rm=TRUE) + 
  xlim(top_seven_nftl) +
  xlab("C_CONF")+ 
  My_Theme

ggplot(cars_ftl,  aes(x = C_CONF, fill = C_SEV)) +
  geom_bar(mapping = aes(x = factor_conf_ftl), colour = "darkgrey" , fill = c("lightblue"),na.rm=TRUE) + 
  xlim(top_seven_ftl) +
  xlab("C_CONF")+ 
  My_Theme

```

```{r plotvars24, echo = FALSE, fig.cap='Road User Class', fig.subcap=c('Non-fatal accidents', 'Fatal accidents'), fig.dim = c(8, 6), out.width='.49\\linewidth', fig.asp=1, fig.ncol = 2,fig.show="hold"}
cars_copy_person_nftl <- cars_copy %>%
  filter(P_ISEV != "3")
cars_copy_person_ftl <- cars_copy %>%
  filter(P_ISEV == "3")

lbl_p_user <- c("Motor Vehicle Driver", "Motor Vehicle Passenger", 
                "Pedestrian", "Bicyclist", "Motorcyclist")


ggplot(cars_copy_person_nftl,  aes(x = P_USER)) +
  geom_bar(colour = "darkgrey", fill=c("lightblue")) +
  xlab("P_USER") +
  scale_x_discrete(labels=wrap_10(lbl_p_user))+ 
  My_Theme


ggplot(cars_copy_person_ftl,  aes(x = P_USER)) +
  geom_bar(colour = "darkgrey", fill=c("lightblue")) +
  xlab("P_USER")  +
  scale_x_discrete(labels=wrap_10(lbl_p_user))+ 
  My_Theme

```
### Person Level Analysis

- Relationship between medical treatment required and the use of safety device in a fatal accident (Figure \ref{fig:plotvars25}): When there's a severe accident and a person involved in it is not using
a safety device, the most frequent case is that it will lead to a loss
of life, while for the ones using a safety device, the most frequent case
is that they will end up being injured.

- Relationship between medical treatment required and an elderly involved in a fatal accident (Figure \ref{fig:plotvars26}.\subref*{fig:plotvars26-1}): When there's a severe accident and an elderly involved in it, the most
frequent case is the loss of life for these risk population.

- Relationship between medical treatment required and an underage involved in a fatal accident (Figure \ref{fig:plotvars26}.\subref*{fig:plotvars26-2}): In the case of the underage, if they are involved in a fatal accident
the frequent case is that they will receive medical treatment for an
injury.

```{r plotvars25, echo = FALSE, fig.cap='Medical treatment for person in a fatal accident by the used of safety device', fig.subcap=c('Without safety device used', 'With safety device used'), out.width='.49\\linewidth', fig.asp=1, fig.ncol = 2,fig.show="hold",fig.dim = c(8, 6)}
lbl_isev = c("F", "Injury")

cars_ftl_no_fatal <- cars_copy %>%
  filter(C_SEV == "2") 

cars_ftl_fatal <- cars_copy %>%
  filter(C_SEV == "1") 

cars_ftl_no_fatal$C_SAFE <- case_when(cars_ftl_no_fatal$P_SAFE == "01" | cars_ftl_no_fatal$P_SAFE == "13"  ~ "1",
                          cars_ftl_no_fatal$P_SAFE != "01" & cars_ftl_no_fatal$P_SAFE != "13"  ~ "0")

cars_ftl_fatal$C_SAFE <- case_when(cars_ftl_fatal$P_SAFE == "01" | cars_ftl_fatal$P_SAFE == "13"  ~ "1",
                          cars_ftl_fatal$P_SAFE != "01" & cars_ftl_fatal$P_SAFE != "13"  ~ "0")

ggplot(cars_ftl_no_fatal,  aes(x = C_SAFE)) +
  geom_bar(colour = "darkgrey", fill=c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_isev))+ 
  My_Theme


ggplot(cars_ftl_fatal,  aes(x = C_SAFE)) +
  geom_bar(colour = "darkgrey", fill=c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_isev))+ 
  My_Theme

```

```{r plotvars25, echo = FALSE, fig.cap='Medical treatment for person in a fatal accident by the used of safety device', fig.subcap=c('Without safety device used', 'With safety device used'), out.width='.49\\linewidth', fig.asp=1, fig.ncol = 2,fig.show="hold",fig.dim = c(8, 6)}
lbl_isev = c("No injury", "Injury", "Fatality")

cars_ftl_no_seatbelt <- cars_copy %>%
  filter(P_SAFE == "01" | P_SAFE == "13")

cars_ftl_seatbelt <- cars_copy %>%
  filter(P_SAFE != "01" & P_SAFE != "13")


ggplot(cars_ftl_no_seatbelt,  aes(x = P_ISEV)) +
  geom_bar(colour = "darkgrey", fill=c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_isev))+ 
  My_Theme


ggplot(cars_ftl_seatbelt,  aes(x = P_ISEV)) +
  geom_bar(colour = "darkgrey", fill=c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_isev))+ 
  My_Theme

```

```{r plotvars25, echo = FALSE, fig.cap='Medical treatment for person in a fatal accident by the used of safety device', fig.subcap=c('Without safety device used', 'With safety device used'), out.width='.49\\linewidth', fig.asp=1, fig.ncol = 2,fig.show="hold",fig.dim = c(8, 6)}
lbl_isev = c("No injury", "Injury", "Fatality")

cars_ftl_no_seatbelt <- cars_copy %>%
  filter(C_SEV == "1" & P_SAFE == "01" ) 

cars_ftl_seatbelt <- cars_copy %>%
  filter(C_SEV == "1" & P_SAFE == "02" ) 


ggplot(cars_ftl_no_seatbelt,  aes(x = P_ISEV)) +
  geom_bar(colour = "darkgrey", fill=c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_isev))+ 
  My_Theme


ggplot(cars_ftl_seatbelt,  aes(x = P_ISEV)) +
  geom_bar(colour = "darkgrey", fill=c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_isev))+ 
  My_Theme

```

```{r plotvars26, echo = FALSE, fig.cap='Medical treatment required when there is:', fig.subcap=c('An elderly involved in a fatal accident', 'An underage person involved in a fatal accident'), out.width='.49\\linewidth', fig.asp=1, fig.ncol = 2,fig.show="hold",fig.dim = c(8, 6)}
lbl_isev = c("No injury", "Injury", "Fatality")

cars_ftl_elder_involved <- cars_copy %>%
  filter(C_SEV == "1" & as.numeric(P_AGE) >= 65 ) 

ggplot(cars_ftl_elder_involved,  aes(x = P_ISEV)) +
  geom_bar(colour = "darkgrey", fill=c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_isev))+ 
  My_Theme

lbl_isev = c("No injury", "Injury", "Fatality")

cars_ftl_child_involved <- cars_copy %>%
  filter(C_SEV == "1" & as.numeric(P_AGE) <= 18 ) 

ggplot(cars_ftl_child_involved,  aes(x = P_ISEV)) +
  geom_bar(colour = "darkgrey", fill=c("lightblue")) +
  scale_x_discrete(labels=wrap_10(lbl_isev))+ 
  My_Theme
 
```
## Reduced Data Frame

As we explained, we will focus on the analysis at accident level, so we will
remove those variables that only make sense at person level and vehicle
level.
```{r eliminatevar}
#Eliminate variables that does not have sense at accident level
cars <- cars[, !names(cars) %in% c("V_ID", "V_TYPE", "V_YEAR", "P_ID", "P_SEX",  
                                   "P_AGE", "P_PSN", "P_ISEV", "P_SAFE", "P_USER")]
```

## Data Science questions

In this report, we assume the role of data scientists working for
Transport Canada, the federal institution responsible for transportation
policies and programs. Our main objective is to find the most effective
way to allocate resources for traffic surveillance in Canada. To achieve
this, we will address the following questions:

Regarding when/where to allocate resources:

-   Which time and day of the week is more probable that an accident with fatalities occurs?

-   What kind of weather condition is most prevalent during car accidents with fatalities?

-   Is there a correlation between the road configuration and the severity of the accident?

-   Is there a correlation between the road alignment and the severity of the accident?
    
Regarding preventive measures campaigns:

-   How does the safety device affect the likelihood of casualties in traffic accidents?

-   When there is elderly and underage people involved in a car accident, is it more probable to have fatalities reported?


## Dependent variable

We decided to use the binary variable C_SEV as the outcome variable,
which represents the presence or absence of a fatality in the accident.
For this purpose, we transformed the original variable to match 0
(collision producing non-fatal injury), and 1 (collision producing at
least one fatality). In Table \@ref(tab:tabledepvar), the distribution
of the dependent variable shows a heavy unbalanced data, with 1,229,743
examples for the majority class and 24,797 for the minority class.

```{r dependent.variable}
cars$C_SEV_FACTOR <- case_when(cars$C_SEV == "1"  ~ "1",
                          cars$C_SEV == "2"   ~ "0")
cars$C_SEV_FACTOR <- factor(cars$C_SEV_FACTOR)
```

```{r tabledepvar,echo=FALSE, fig.show="hold", fig.show="hold" }
knitr::kable(table(cars$C_SEV_FACTOR), col.names = c('C_SEV_FACTOR', 'Frequency'), "latex", align = "c", caption = "Dependent variable frequency") %>%
  kable_styling(font_size = 10)
```

```{r plotdepvar, fig.cap = "Dependent Variable", echo=FALSE, fig.show="hold", out.width="50%", fig.align = 'center',fig.dim = c(8, 6)}
ggplot(data = cars) +
  geom_bar(mapping = aes(x = C_SEV_FACTOR), colour = "dark grey", fill = c("lightblue", "#DD8888")) +
  theme(plot.title = element_text(hjust = 0.5))+ 
  My_Theme
```

## Feature Engineering

### Dimensionality reduction

The previous graphs show that some of the categorical variables have
many levels with low frequency. To make them easier to interpret and
reduce the dimensionality, we grouped some of these levels together. We
applied this modification to the following variables:

-   Time of the day (C_HOUR): Specific hours are not needed. We rather
    focus on time frames, ending up with four groups (early morning,
    morning, afternoon, evening).

-   Numbers of cars involved in the accident (C_VEHS): Because of the
    frequency of the levels, it was modified to 1, 2, and 3 or more.

-   Collision configuration (C_CONF): Because of the frequency of the
    levels, the existent divisions were classified in five groups.

-   Roadway Configuration (C_RCFG): Because of the frequency of the
    levels, the existent divisions were classified in three groups.

-   Traffic control (C_TRAF): Because of the frequency of the levels,
    the existent divisions were classified in six groups.

```{r plot.level.reduction, include=FALSE}
# For plotting purposes
C_HOUR_INT <- strtoi(str_replace(cars$C_HOUR,"^0", ""))

C_HOUR_plot <- factor(
  case_when(C_HOUR_INT >= 0 &  C_HOUR_INT <= 5  ~ "Early Morning",
            C_HOUR_INT >= 6 &  C_HOUR_INT <= 11  ~ "Morning",
            C_HOUR_INT >= 12 &  C_HOUR_INT <= 17  ~ "Afternoon",
            C_HOUR_INT >= 18 &  C_HOUR_INT <= 23  ~ "Evening"), 
  ordered = TRUE,
  levels = c("Early Morning", "Morning", "Afternoon", "Evening"))

C_VEHS_plot <- factor(
  case_when(cars$C_VEHS == "01"  ~ "One vehicle",
            cars$C_VEHS == "02"  ~ "Two vehicles",
            cars$C_VEHS != "01" & cars$C_VEHS != "02" ~ "Three or more vehicles"), 
  ordered = TRUE,
  levels = c("One vehicle", "Two vehicles", "Three or more vehicles"))


C_CONF_plot <- factor(
  case_when(
    cars$C_CONF == "01" | cars$C_CONF == "02" | cars$C_CONF == "03" | 
    cars$C_CONF == "04" | cars$C_CONF == "05" | cars$C_CONF == "06" 
    ~ "Single Vehicle in Motion",
    cars$C_CONF == "21" | cars$C_CONF == "22" | cars$C_CONF == "23" | 
      cars$C_CONF == "24" | cars$C_CONF == "25" 
    ~ "Two Vehicles in Motion - Same Direction of Travel",
    cars$C_CONF == "31" | cars$C_CONF == "32" | cars$C_CONF == "33" |
      cars$C_CONF == "34" | cars$C_CONF == "35" | cars$C_CONF == "36"  
    ~ "Two Vehicles in Motion - Different Direction of Travel",
    cars$C_CONF == "41"  ~ "Two Vehicles - Hit a Parked Motor Vehicle", 
    cars$C_CONF == "QQ"  ~ "Choice is other than the preceding values"), 
  ordered = TRUE, 
  levels = c("Single Vehicle in Motion", 
             "Two Vehicles in Motion - Same Direction of Travel", 
             "Two Vehicles in Motion - Different Direction of Travel", 
             "Two Vehicles - Hit a Parked Motor Vehicle", 
             "Choice is other than the preceding values"))

C_RCFG_plot <- factor(case_when(
  cars$C_RCFG == "01"  ~ "Non-intersection",
  cars$C_RCFG == "02"  ~ "At an intersection of at least two public roadways",
  cars$C_RCFG != "01" & cars$C_RCFG != "02"  ~ "Choice is other than the preceding values"), 
  ordered = TRUE, levels = c("Non-intersection", 
                             "At an intersection of at least two public roadways", 
                             "Choice is other than the preceding values"))

C_TRAF_plot <- factor(case_when(
  cars$C_TRAF == "01" ~ "Traffic signals fully operational",
  cars$C_TRAF == "03" ~ "Stop sign",
  cars$C_TRAF == "04" ~ "Yield sign",
  cars$C_TRAF == "06" ~ "Pedestrian crosswalk",
  cars$C_TRAF == "18" ~ "No control present",
  cars$C_TRAF != "01" & cars$C_TRAF != "03" & cars$C_TRAF != "04" & 
    cars$C_TRAF != "06" & cars$C_TRAF != "18" ~ "Choice is other than the preceding values"), 
  ordered = TRUE, levels = c("Traffic signals fully operational", 
                             "Stop sign", "Yield sign", "Pedestrian crosswalk", 
                             "No control present", "Choice is other than the preceding values"))
```

```{r level.reduction}
# Level reduction
cars$C_HOUR_AGR <- case_when(
  C_HOUR_INT >= 0 &  C_HOUR_INT <= 5  ~ "Early Morning",
  C_HOUR_INT >= 6 &  C_HOUR_INT <= 11  ~ "Morning",
  C_HOUR_INT >= 12 &  C_HOUR_INT <= 17  ~ "Afternoon",
  C_HOUR_INT >= 18 &  C_HOUR_INT <= 23  ~ "Evening")

cars$C_VEHS_AGR <- case_when(
  cars$C_VEHS == "01"  ~ "1",
  cars$C_VEHS == "02"  ~ "2",
  cars$C_VEHS != "01" & cars$C_VEHS != "02" ~ "+3")

cars$C_CONF_AGR <- case_when(
  cars$C_CONF == "01" | cars$C_CONF == "02" | cars$C_CONF == "03" |
    cars$C_CONF == "04" | cars$C_CONF == "05" | cars$C_CONF == "06"  ~ "1",
  cars$C_CONF == "21" | cars$C_CONF == "22" | cars$C_CONF == "23" |
    cars$C_CONF == "24" | cars$C_CONF == "25"  ~ "2",
  cars$C_CONF == "31" | cars$C_CONF == "32" | cars$C_CONF == "33" |
    cars$C_CONF == "34" | cars$C_CONF == "35" | cars$C_CONF == "36"  ~ "3", 
  cars$C_CONF == "41"  ~ "4",
  cars$C_CONF == "QQ"  ~ "5")

cars$C_RCFG_AGR <- case_when(
  cars$C_RCFG == "01"  ~ "1",
  cars$C_RCFG == "02"  ~ "2",
  cars$C_RCFG != "01" & cars$C_RCFG != "02"  ~ "3")

cars$C_TRAF_AGR <- case_when(
  cars$C_TRAF == "01" ~ "1",
  cars$C_TRAF == "03" ~ "3",
  cars$C_TRAF == "04" ~ "4",
  cars$C_TRAF == "06" ~ "6",
  cars$C_TRAF == "18" ~ "18",
  cars$C_TRAF != "01" & cars$C_TRAF != "03" & cars$C_TRAF != "4" 
  & cars$C_TRAF != "06" & cars$C_TRAF != "18" ~ "Other")

```

```{r plotvar1, echo = FALSE, fig.cap='Reduced Variables', fig.subcap=c("C HOUR AGR distribution", "C VEHS AGR distribution","C CONF AGR distribution", "C RCFG AGR distribution","C TRAF AGR distribution"), out.width='.49\\linewidth', fig.asp=1, fig.ncol = 2,fig.show="hold",fig.dim = c(8, 6)}

ggplot(data = cars) +
  geom_bar(mapping = aes(x = C_HOUR_plot), colour = "dark grey", fill = c("lightblue")) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_discrete(labels=wrap_10)+ 
  My_Theme

ggplot(data = cars) +
  geom_bar(mapping = aes(x = C_VEHS_plot), colour = "dark grey", fill = c("lightblue")) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_discrete(labels=wrap_10)+ 
  My_Theme

ggplot(data = cars) +
  geom_bar(mapping = aes(x = C_CONF_plot), colour = "dark grey", fill = c("lightblue")) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_discrete(labels=wrap_10)+ 
  My_Theme

ggplot(data = cars) +
  geom_bar(mapping = aes(x = C_RCFG_plot), colour = "dark grey", fill = c("lightblue")) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_discrete(labels=wrap_10)+ 
  My_Theme

ggplot(data = cars) +
  geom_bar(mapping = aes(x = C_TRAF_plot), colour = "dark grey", fill = c("lightblue")) + 
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_discrete(labels=wrap_10)+ 
  My_Theme

```
## Transformation of variables to factor

Up to now we have a mix of variable types, but all of them should
be categorical. Hence, we transform all the variables into factor.
All variables show no specific order.

```{r transform.variables.factor}
#Transform variables to factor
cars$C_MNTH <- factor(cars$C_MNTH,
                      labels = c("jan", "feb", "mar", "apr", "may", "jun", "jul",
                                 "aug", "sep", "oct", "nov", "dic"))
cars$C_WDAY <- factor(cars$C_WDAY,
                      labels = c("mon", "tue", "wed", "thu","fri", "sat", "sun"))
cars$C_HOUR_AGR <- factor(cars$C_HOUR_AGR)
cars$C_VEHS_AGR <- factor(cars$C_VEHS_AGR, 
                          levels = c("1", "2", "+3"))
cars$C_CONF_AGR  <- factor(cars$C_CONF_AGR, 
                           labels = c("single", "two same direction", 
                                      "two different direction",
                                      "hit a parked motor vehicle", "other"))
cars$C_RCFG_AGR <- factor(cars$C_RCFG_AGR,
                          labels = c("non-intersection", "at an intersection", "other"))
cars$C_WTHR  <- factor(cars$C_WTHR, 
                       labels = c("clear", "overcast", "raining", "snowing", 
                                  "freezing rain", "visibility limitation", 
                                  "string wind", "other"))
cars$C_RSUR  <- factor(cars$C_RSUR, 
                       labels = c("dry", "wet", "snow", "slush", "icy", "sand/dirt",
                                  "muddy", "oil", "flooded", "other"))
cars$C_RALN  <- factor(cars$C_RALN)
cars$C_TRAF_AGR  <- factor(cars$C_TRAF_AGR, 
                           labels = c("traffic signals fully operational", 
                                      "stop sign", "yield sign", "pedestrian crosswalk", 
                                      "no control present", "other"))
```

## Variable creation

We created three new variables from the original ones to preserve the
information at person level and to measure its effect on the output. The
first variable, P_CHILD, represents the impact of having people under
age of majority involved in the accident. The second variable, P_ELD,
represents the impact of having people aged 65 or older involved in the
accident. The third variable, C_SAFE, represents the impact of having
people who did not use safety devices at the time of the accident. After
this, we set the values of these variables to 1 when there exists at least
one person in the accident who satisfies this condition.

```{r creating.variables}
cars_copy$P_AGE <- as.numeric(cars_copy$P_AGE)

cars_copy$P_CHILD <- case_when(cars_copy$P_AGE <= 18  ~ "1",
                          cars_copy$P_AGE > 18   ~ "0")

cars_copy$P_ELD <- case_when(cars_copy$P_AGE < 65  ~ "0",
                          cars_copy$P_AGE >= 65   ~ "1")

cars_copy$C_SAFE <- case_when(cars_copy$P_SAFE == "01" | cars_copy$P_SAFE == "13"  ~ "1",
                          cars_copy$P_SAFE != "01" & cars_copy$P_SAFE != "13"  ~ "0")
```

```{r adding.variables}
#Collapse dummies one by accident
cars_2 <- cars_copy[,c('ID','P_CHILD','P_ELD', 'C_SAFE')] %>% 
  group_by(ID) %>% 
  summarise_all(max)

#Merge the new variables with our dataset
cars <- merge(cars,cars_2, by = "ID", all.x = TRUE, all.y = FALSE)

#Factor these new variables
cars$P_ELD  <- factor(cars$P_ELD)
cars$P_CHILD  <- factor(cars$P_CHILD)
cars$C_SAFE  <- factor(cars$C_SAFE)
```

## Final Dataframe

```{r final.dataframe}
accidents <- cars[,c('C_SEV_FACTOR','C_MNTH','C_WDAY', 'C_HOUR_AGR','C_VEHS_AGR',
                     'C_CONF_AGR', 'C_TRAF_AGR', 'C_RSUR','C_WTHR','C_RALN',
                     'C_RCFG_AGR','P_CHILD','P_ELD', 'C_SAFE')]
nrows.base.df2 <- nrow(accidents)
```

Finally, the data set is composed by `r nrows.base.df2` examples and 14 columns (13 independent variables).

```{r headfinal1, echo = FALSE, fig.show='hold'}
knitr::kable(head(accidents[0:6]), "latex", align = "c", caption = "Head of the Final Dataframe")%>%
  kable_styling(font_size = 7)
```

```{r headfinal2, echo = FALSE, fig.show='hold'}
knitr::kable(head(accidents[7:14]), "latex", align = "c", caption = "Head of the Final Dataframe")%>%
  kable_styling(font_size = 7)
```


# Model

Our objective is to predict whether or not a car accident is likely to
end with fatalities or not based on different characteristic of the
accident. So, as the output variable is car crash with fatality or not,
this problem is a binary classification problem. We decided to apply
two popular methods for classification problems: Logistic regression
and KNN. Logistic regression is a parametric method that assumes a
linear relationship between the input variables and the output variable.
It uses a logistic function to model the probability of an outcome, such
as whether a car accident is fatal or not. KNN is a non-parametric
method that does not make any assumptions about the data distribution.
It uses the distance between the input variables and the nearest
neighbors to assign a class label, such as fatal or non-fatal.

Both methods have advantages and disadvantages for classifying car
accidents. Logistic regression can provide confidence levels for its
predictions and can handle multiple input variables easily. However, it
may not capture non-linear patterns in the data and may be affected by
outliers and collinearity. KNN can handle non-linear solutions and does
not require any training. However, it may be slower than logistic
regression and may be sensitive to the choice of K and the distance
metric.

## Undersampling

The dataset we are working with has a severe class imbalance problem,
meaning that the fatal car crash cases are much less frequent than the
non-fatal ones. This can affect the model's performance and accuracy, as
it tends to predict the majority class more often and neglect the
minority class. To address this issue, we apply undersampling, which
reduces the number of samples from the non-fatal class to make the
dataset more balanced. Another common technique is oversampling, but we
choose undersampling because our dataset is large and the difference
between the classes is significant. Instead, oversampling would create a lot of
synthetic data from the fatal class, which may not be representative of
the real cases.

One way to reduce the imbalance between the classes of fatal and
non-fatal accidents is to use random under-sampling on the majority
class. This can be done with the "ovun" function from the ROSE package in
R, which randomly selects a subset of observations from the non-fatal
accidents class.

```{r undersampling}
set.seed(123)
#We set a seed to replicate results
cars_u <- ovun.sample(C_SEV_FACTOR ~ ., 
                      data = accidents, seed = 123, method = "under")$data
```

## Logistic Regression

The dependent variable for this research is C_SEV_FACTOR and stands for
accident severity. It takes the value 1 if the car accidents has at
least one fatality and 0 if the car crash has non fatality. The logistic
regression equation for our problem is:

$$
\log\left(\frac{p}{1-p}\right) = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + ... + \beta_k x_k
$$

where $p$ is the probability of the event, in this case the probability
of a fatal accident, $\beta_0$ is the intercept,
$\beta_1, \beta_2, ..., \beta_k$ are the coefficients, and
$x_1, x_2, ..., x_k$ are the predictor variables. For our model, all the
independent variables are categorical, therefore they were transformed
to factor in the previous section.

Logistic regression determines the coefficients that make the observed
outcome (non-fatal or fatal accident) most likely using the
maximum-likelihood technique.

We use the glm function in R to fit the logistic regression as follows:

```{r logistic.train}
# Fit the model
model_full <- glm(C_SEV_FACTOR~., data = cars_u, family = binomial)
```

Before going deeper in the analysis of the logistic regression results,
we have to check the model assumptions and its performance.

### Model Assumptions

#### Multicollinearity (Independency): Look for correlations among categorical variables
\
\
To look for dependencies between features, we used Cramer's V test,
which is based on the Chi Square statistic. It varies from 0
(corresponding to no association between the variables) to 1 (complete
association) and can reach 1 only when each variable is completely
determined by the other. The heat map in Figure \ref{fig:plotcramer} depicts the strength of
association between the different explanatory variables.

```{r CramerV, warning=FALSE}
cramer.matrix <- function(x) {
  names <- colnames(x);
  ndim <- length(names)
  stats <- matrix(nrow=ndim, ncol=ndim, dimnames = list(names, names))
  for (i in 1:ndim) {
    for (j in i:ndim) {
      stats[i,j] = cramerV(x[,i],x[,j])
      if (i != j) {
        stats[j,i] = NA
      }
    }
  }
  return (stats)
}
```

```{r plotcramer, echo=FALSE, fig.align='center', fig.cap='Cramers V between features', fig.show="hold", warning=FALSE}
mat2 <- cramer.matrix(accidents[, !names(accidents) %in% c("C_SEV_FACTOR")])
data_melt <- melt(mat2, na.rm = TRUE) 
ggplot(data_melt, aes(X1, X2)) + scale_fill_gradient(low = "white", high = "red", na.value = "white") + geom_tile(aes(fill = value)) + theme(axis.text.x = element_text(angle = 90)) + geom_text(aes(label = round(value, 2))) + ggtitle("Cramer's V between features") +
  theme(plot.title = element_text(hjust = 0.5))
```

Based on these results, it was possible to preliminarily identify pair of
variables that are dependent from each other:

-   Collision configuration (C_CONF_AGR) and Number of vehicles involved
    in collision (C_VEHS_AGR): The number of vehicles determines the
    configuration of the collision.

-   Weather conditions (C_WTHR) and Road surface (C_RSUR): The type of
    weather explains in most cases the characteristics of the surface.

-   Traffic control (C_TRAF) and Roadway configuration (C_RCFG_AGR): The
    type of roadway could explain the presence or absence of traffic
    signs.

To confirm these findings, we plotted the variables against each other.

```{r corr.var.graphs, echo=FALSE, warning=FALSE}
agg <- count_(cars_u, names(cars_u))
agg_ord <- mutate(agg,
                  C_WTHR = reorder(C_WTHR, -n, sum),
                  C_RSUR = reorder(C_RSUR, -n, sum),
                  C_CONF_AGR = reorder(C_CONF_AGR, -n, sum),
                  C_VEHS_AGR = reorder(C_VEHS_AGR, -n, sum),
                  C_RCFG_AGR = reorder(C_RCFG_AGR, -n, sum),
                  C_TRAF_AGR = reorder(C_TRAF_AGR, -n, sum))
```
```{r corrvars1, echo=FALSE, fig.align="center", fig.asp=1, fig.cap='Correlated Variables', fig.dim=c(8, 6), fig.ncol=2, fig.show="hold", warning=FALSE, out.width='.49\\linewidth'}
ggplot(agg_ord) +
    geom_col(aes(x = C_WTHR, y = n, fill = C_RSUR))+ 
  My_Theme2
ggplot(agg_ord) +
    geom_col(aes(x = C_CONF_AGR, y = n, fill = C_VEHS_AGR))+ 
  My_Theme2
ggplot(agg_ord) +
    geom_col(aes(x = C_RCFG_AGR, y = n, fill = C_TRAF_AGR))+ 
  My_Theme2
```
It is important to mention that we used the Chi-square statistic to test
the independence of the variables, but we preferred the Cramer's V as a
measure of association, since it indicates how strong the relationship
is, and is also independent from the sample size. Additionally, we
considered using Yule's Q, but this metric compares each pair of levels,
which was not suitable for our data set with many levels.

Regarding the normality of residuals, logistic regression models are not
based on the normal distribution. Therefore, the normality of residuals
is not an assumption for logistic regression models. Same applies for
KNN, which is a non-parametric method and does not make any assumptions
about the distribution of the data.

#### Removing Correlated variables
\
\
To avoid multicollinearity, we need to drop one of the correlated
variables that the Cramer's V test revealed. We will use the AIC
criterion to compare the full model and the models with each correlated
variable omitted. The variable with the lowest AIC will be retained. If
there is a tie, we will favor the variable with fewer levels for easier
interpretation.

```{r removecorrvar}
#First pair of correlated variables
model_c1v1 <- glm(  C_SEV_FACTOR~. - C_WTHR, data = cars_u, family = binomial)
model_c1v2 <- glm(  C_SEV_FACTOR~. - C_RSUR, data = cars_u, family = binomial)
#Second pair of correlated variables
model_c2v1 <- glm(  C_SEV_FACTOR~. - C_CONF_AGR, data = cars_u, family = binomial)
model_c2v2 <- glm(  C_SEV_FACTOR~. -C_VEHS_AGR, data = cars_u, family = binomial)
#Third pair of correlated variables
model_c3v1 <- glm(  C_SEV_FACTOR~. -C_RCFG_AGR, data = cars_u, family = binomial)
model_c3v2 <- glm(  C_SEV_FACTOR~. -C_TRAF_AGR, data = cars_u, family = binomial)

```

```{r tableaic, echo = FALSE}
#Show AIC of the variables in 
ms <- model.sel(model_c1v1, model_c1v2, model_c2v1, model_c2v2, model_c3v1, model_c3v2)
res <- as.data.frame(ms)
mnames <- c("- C_WTHR", "- C_RSUR", "- C_CONF_AGR", "- C_VEHS_AGR", "-C_RCFG_AGR", "-C_TRAF_AGR")
res <- res[,c('df','AICc')]
res <- cbind(model = mnames, res)
```

```{r tableaiccorr, echo = FALSE}
knitr::kable(head(res), "latex", align = "c", caption = "AIC of models with Correlated Variables")%>%
  kable_styling(font_size = 10)
```

As we can see from Table \@ref(tab:tableaiccorr) following the AIC criteria,
from the pair C_VEHS_AGR and C_CONF_AGR, it is clear that we have the
model with the lowest AIC if we remove C_CONF_AGR. For the other two
pairs the AIC criteria is not determinant, so we keep C_RCFG_AGR and
C_WTHR because they have less levels, being easier to interpret.

After removing the correlated variables the model to be fit in R is as
follows:
```{r fit.full.model}
model <- glm(  C_SEV_FACTOR~. - C_RSUR - C_CONF_AGR -C_TRAF_AGR, 
               data = cars_u, family = binomial)
```

We are going to interpret these results in the Results Section.

#### Accuracy, AUC and ROC  

```{r ROC, message=FALSE, warning=FALSE}
logistic.prob <- predict(model, type="response")
roc.out <- roc(cars_u$C_SEV_FACTOR, logistic.prob, levels=c(0, 1))
roc.coords <- coords(roc.out, x="best", input="threshold")
```
In order to identify the best threshold, we used the ROC curve depicted
in the following figure. The chosen value is `r roc.coords$threshold`, which yields a
specificity of `r roc.coords$specificity` and a sensitivity of `r roc.coords$sensitivity`. The classifier
has a fair performance with an AUC of `r roc.out$auc`.

```{r plotROC, echo=FALSE,fig.show="hold", fig.cap = 'ROC', fig.align = 'center',out.width="50%"}
plot(roc.out, print.auc=TRUE, legacy.axes=TRUE, xlab="False positive rate", ylab="True positive rate")  
roc.coords
```

#### Confusion matrix  
\
\
The same results showed before can be assess by the confusion matrix. We can see that for the model is easier to assess correctly when a car accident has no fatalities, with a high specificity, but not that well when an car accident ends with fatalities, sensitivity of `r roc.coords$sensitivity`.

```{r conf.matrix}
model_prob <- predict(model, newdata = cars_u, type = "response")
model_pred <- 1*(model_prob > roc.coords$threshold) + 0

conf_matrix <- table(pred = model_pred, true = cars_u$C_SEV_FACTOR)
cm <- confusionMatrix(data=factor(model_pred),reference=factor(cars_u$C_SEV_FACTOR))
```

```{r confmatrix.lr, echo=FALSE, fig.align="center", fig.cap='Confusion matrix of logistic regression model', fig.show="hold", message=FALSE, warning=FALSE, out.width="50%"}
TClass <- factor(c(0, 1, 0, 1))
PClass <- factor(c(0, 0, 1, 1))
Y <- c(cm$table[1,1], cm$table[1,2], cm$table[2,1] ,cm$table[2,2])
cm_df <- data.frame(TClass, PClass, Y)

ggplot(data =  cm_df, mapping = aes(x = TClass, y =  reorder( PClass, desc( PClass)))) +
  geom_tile(aes(fill = Y), colour = "white") +
  geom_text(aes(label = sprintf("%1.0f", Y)), vjust = 1) +
  scale_fill_gradient(low = "lightblue", high = "#DD8888") +
  theme_bw() + 
  theme(legend.position = "none",plot.title = element_text(hjust = 0.5)) +
  scale_x_discrete(label=c("Non-fatal","Fatal"),position = "top") +
  xlab("True Class") +
  scale_y_discrete(label=c("Fatal","Non-fatal")) + 
  ylab("Predicted Class") +
  ggtitle("Confusion Matrix")
```

```{r accuracy.train, echo=FALSE}
#Accuracy
accuracy_lr <- sum(model_pred == cars_u$C_SEV_FACTOR) /nrow(cars_u)
```

The accuracy of the model with the best threshold is of `r accuracy_lr`.

#### K-fold Cross-Validation  
\
\
To assess the logistic regression model and detect issues such as
overfitting or selection bias, we use K-fold cross-validation. This
method divides the data into K groups and uses one group as a test set
and the others as a training set. We repeat this procedure K times, each
time with a different group as the test set. The final score of the
model is the average of the K test scores. We set K to 10 for K-fold
cross validation.

```{r cross.validation}
set.seed(123)

#specify the cross-validation method
cv <- trainControl(method = "cv", number = 10, savePredictions=TRUE)

#fit a regression model and use k-fold CV to evaluate performance
model_cv <- train(C_SEV_FACTOR~. - C_RSUR - C_CONF_AGR -C_TRAF_AGR, data = cars_u, 
                  method = "glm", family = binomial, trControl = cv)

#view summary of k-fold CV               
print(model_cv)

pred <- model_cv$pred
pred$equal <- ifelse(pred$pred == pred$obs, 1,0)
eachfold <- pred %>%                                        
  group_by(Resample) %>%                         
  summarise_at(vars(equal),                     
               list(Accuracy = mean))              
```

```{r boxplotkfold, echo = FALSE, fig.cap='Boxplot K-fold', fig.show="hold", out.width="50%", fig.align='center'}
ggplot(data=eachfold, aes(x=Resample, y=Accuracy, group=1)) +
geom_boxplot(color="maroon") +
geom_point() +
theme_minimal()
```

Our model performs well on the training set with k fold cross
validation. It has an average accuracy of about 67% and a low
variability as shown in Figure \ref{fig:boxplotkfold}. This means that our
model is not overfitting the data.

#### Dimensionality Reduction  
\
\
One of the main steps for applying logistic regression is to reduce the
number of variables, because not all them are important, and is possible
that they can cause overfitting. We are going to apply variable
selection, but for our model, as all the variables are significant and
categorical, the model with all the parameters are preferred over the
ones with less parameters.

1.  Stepwise Selection: We apply the function step in R with the AIC
    criteria using forward and backward stepwise selection. In the case
    of Forward selection, it starts with the model with only the
    intercept and considers one variable addition of the model and adds
    the one with the lowest AIC. The backward stepwise selection begins
    with the saturated model, and eliminate variables using the same
    criteria explained before.

```{r var.selection}
#Feature selection AIC
nothing <- glm(  C_SEV_FACTOR~1, data = cars_u, family = binomial)
backwards = step(model , criteria = "AIC", trace=0)
forwards = step(nothing, criteria = "AIC", trace = 0, 
                scope=list(lower=formula(nothing),upper=formula(model), direction="forward"))
```

The final model with Backwards elimination using AIC criteria is:
```{r backward, echo=FALSE}
formula(backwards)
```

The final model with Forward elimination using AIC criteria is:

```{r forward, echo=FALSE}
formula(forwards)
```
As we can see both, backward and forward stepwise selection select the
model with all the variables.

So, in order to control the possible
overfitting, we apply shrinkage regression to reduce the effect of each
parameter in the final model.

#### Shrinkage Regression  
\
\
One of the challenges of logistic regression is to avoid overfitting the
data, which can lead to poor generalization and high variance. A common
technique to address this issue is regularization, which adds a penalty
term to the cost function that depends on the magnitude of the
coefficients. In this report, we will use L1 regularization, also known
as Lasso, which penalizes the absolute value of the coefficients. This
has the effect of shrinking some coefficients to zero, effectively
performing feature selection and reducing the complexity of the model.

```{r traintest}
#Define train and test set
trainIndex <- createDataPartition(cars_u$C_SEV_FACTOR, p = .7,
                                  list = FALSE,
                                  times = 1)
cars.train <- cars_u[ trainIndex,]
cars.val  <- cars_u[-trainIndex,]

y.train <-  cars.train[,1]
```

```{r lambda}
# Searching for the optimal value of lambda
set.seed(123)
cars.train.matrix <- model.matrix( ~., cars.train[, -1])
cv.lasso <- cv.glmnet(cars.train.matrix, y.train, alpha = 1, family = "binomial")

```

```{r graph.lambda, eval=FALSE, fig.cap='Lambda',fig.show="hold", include=FALSE, out.width="50%"}
plot(cv.lasso)
```

```{r lambda.lasso}
# Optimal value of lambda that minimizes the cross-validation error
lambda.min <- cv.lasso$lambda.min
```

We obtained a cross-validation error minimum at lambda `r lambda.min`,
which improves the accuracy by about 2 percentage points. It is possible
to get better results by changing the logistic regression threshold, but
we used the same one as in the non-regularized case for a fair
comparison.

```{r model.lasso}
# Model with best lambda value
lasso.model <- glmnet(cars.train.matrix , y.train, alpha = 1, family = "binomial",
                      lambda = cv.lasso$lambda.min)
```

```{r acc.lasso}
# Accuracy of regularized model with best lambda value
cars_u.matrix <- model.matrix( ~., cars_u[, -1])

model_prob <- lasso.model %>% predict(newx = cars_u.matrix)  

model_pred <- 1*(model_prob > roc.coords$threshold) + 0
accuracy_lasso <- sum(model_pred == cars_u$C_SEV_FACTOR) /nrow(cars_u)
```

The accuracy with a L1 regularization with the best lambda is `r accuracy_lasso`.

#### Stability of the parameters with undersampling  
\
\
Due to the great difference between the majority and minority class, we
checked the stability of parameters of the models for different
undersampled data. To do this, we undersampled the data set using 10
different seeds, fit each model using glm, and calculate the mean and
standard deviation using each of the ten values for every level. The
obtained values are displayed in the table, which does not show any
level that varies too much from its mean value (in the case of the
levels that have higher mean values), thus ensuring representativeness
of the sample of the majority class used in the undersampling process.

```{r undersampling.stability}
options(width = 100)
set.seed(123)
list_seed = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
mod_summaries <- list() 
for(i in 1:length(list_seed)) {                 # Head of for-loop
  cars_u <- ovun.sample(C_SEV_FACTOR ~ ., data = accidents, 
                        seed = list_seed[i], method = "under")$data

  model_loop <- glm(C_SEV_FACTOR~. - C_RSUR - C_CONF_AGR -C_TRAF_AGR, 
                    data = cars_u, family = binomial)
  assign(gsub(" ", "", paste('model_', toString(i), collapse = ""), 
              fixed = TRUE), model_loop)
  }

compare_glm <- compareGLM(model_1, model_2, model_3, model_4, model_5, 
           model_6, model_7, model_8, model_9, model_10)

compare_glm$Fit.criteria
```

```{r undersampling.stability.comparison}
# Cofficients variability:
coef_mean = (model_1$coefficients[2:length(model_1$coefficients)] + 
               model_2$coefficients[2:length(model_2$coefficients)] 
             + model_3$coefficients[2:length(model_3$coefficients)] 
             + model_4$coefficients[2:length(model_4$coefficients)] 
             + model_5$coefficients[2:length(model_5$coefficients)] 
             + model_6$coefficients[2:length(model_6$coefficients)] 
             + model_7$coefficients[2:length(model_7$coefficients)] 
             + model_8$coefficients[2:length(model_8$coefficients)] 
             + model_9$coefficients[2:length(model_9$coefficients)] 
             + model_10$coefficients[2:length(model_10$coefficients)]) / 10

aux = list(model_1$coefficients[2:length(model_1$coefficients)], 
           model_2$coefficients[2:length(model_2$coefficients)], 
           model_3$coefficients[2:length(model_3$coefficients)], 
           model_4$coefficients[2:length(model_4$coefficients)], 
           model_5$coefficients[2:length(model_5$coefficients)], 
           model_6$coefficients[2:length(model_6$coefficients)], 
           model_7$coefficients[2:length(model_7$coefficients)], 
           model_8$coefficients[2:length(model_8$coefficients)], 
           model_9$coefficients[2:length(model_9$coefficients)],
           model_10$coefficients[2:length(model_10$coefficients)])

coef_sd <- c()
for (j in 1:length(aux[[c(1)]])) {
  list_aux = c()
  for (i in 1:10){
    list_aux <- append(list_aux, aux[[c(i, j)]])
  }
  coef_sd <- append(coef_sd, sd(list_aux))
}
cbind(coef_mean, coef_sd)
```

## KNN

We applied the KNN algorithm to our data and experimented with different
values of K to find the optimal one. 

```{r knnmodel}
#Define train and test set
trainIndex <- createDataPartition(cars_u$C_SEV_FACTOR, p = .7,
                                  list = FALSE,
                                  times = 1)
cars.train <- cars_u[ trainIndex,]
cars.val  <- cars_u[-trainIndex,]

y.train <-  cars.train[,1]

cars.knn.train <- cars.train
cars.knn.val <- cars.val
columns <- names(cars.knn.train)

for (var in columns) {
  cars.knn.train[[var]] <- as.integer(cars.knn.train[[var]])
  cars.knn.val[[var]] <- as.integer(cars.knn.val[[var]])
}

y.train <-  cars.knn.train[,1]
cars.knn.train <- cars.knn.train[,-1]
y.val <- cars.knn.val[,1]
cars.knn.val <- cars.knn.val[,-1]
```

```{r bestK}
k.values <- 1:40
accuracy <- vector() 

set.seed(123)
for (k in k.values) {
  knn.pred <- knn(cars.knn.train , cars.knn.val, y.train, k=k)
  acc <- mean(knn.pred==y.val)
  accuracy <- c(accuracy, acc)
}
```

```{r graphknn, echo = FALSE, fig.cap='Accuracy of KNN model in the validation set', fig.align ="center", fig.show="hold",out.width="50%"}
k.acc.df <- data.frame(K = k.values, accuracy = accuracy)
top.accuracy <- max(accuracy)

top.k <-  which.max(k.acc.df$accuracy)

ggplot(k.acc.df, aes(x = K, y = accuracy)) +
  geom_line() +
  geom_point(size = 2) +
  geom_text(aes(label = ifelse(accuracy == top.accuracy, round(accuracy, 4), "")),
            vjust = -0.5, size = 4) +
  labs(title = "Accuracy of KNN Model", x = "K", y = "Accuracy")  +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r accknn}
set.seed(123)
knn.pred <- knn(cars.knn.train , cars.knn.val, y.train, k=top.k)
accuracy_knn_val <- mean(knn.pred==y.val)
```

The mean accuracy applying KNN in the validation set with K between 1 and 40 is `r accuracy_knn_val` with a top accuracy of `r top.accuracy`.
The best K turned out to be `r top.k`, which gave us an accuracy of `r top.accuracy`.

### Accuracy on full dataset with undersampling  

```{r knn.under}
cars_u_knn <- rbind(cars.knn.train, cars.knn.val)
cars_u_knn.pred <- knn(cars.knn.train , cars_u_knn, y.train, k=top.k)
cars_u.y <- c(y.train, y.val)
cm <- confusionMatrix(data=factor(cars_u_knn.pred),reference=factor(cars_u.y ))
accuracy_knn <- cm[["overall"]][["Accuracy"]]
knn_specificity <- cm[["byClass"]][["Specificity"]]
knn_sensitivity <- cm[["byClass"]][["Sensitivity"]]
```

```{r knngraph, echo = FALSE, fig.cap='Confusion matrix of KNN model', fig.align ="center", fig.show="hold",out.width="50%"}
TClass <- factor(c(0, 1, 0, 1))
PClass <- factor(c(0, 0, 1, 1))
Y <- c(cm$table[1,1], cm$table[1,2], cm$table[2,1] ,cm$table[2,2])
cm_df <- data.frame(TClass, PClass, Y)

ggplot(data =  cm_df, mapping = aes(x = TClass, y =  reorder( PClass, desc( PClass)))) +
  geom_tile(aes(fill = Y), colour = "white") +
  geom_text(aes(label = sprintf("%1.0f", Y)), vjust = 1) +
  scale_fill_gradient(low = "lightblue", high = "#DD8888") +
  theme_bw() + 
  theme(legend.position = "none",plot.title = element_text(hjust = 0.5)) +
  scale_x_discrete(label=c("Non-fatal","Fatal"),position = "top") +
  xlab("True Class") +
  scale_y_discrete(label=c("Fatal","Non-fatal")) + 
  ylab("Predicted Class") +
  ggtitle("Confusion Matrix")

```

Finally we applied the best K obtained in the validation set to the complete data set with undersampling. We obtained an accuracy of `r accuracy_knn` . This is a slight improvement over the
non regularized logistic regression model. We also showed the confusion matrix (Figure \ref{fig:knngraph}). The specifity and sensitivity of our model were `r knn_specificity` and `r knn_sensitivity`, respectively.

# Results  

In this section we are going to interpret the results of the Logistic regression and KNN model and compare both models.
The final Logistic Regression model after eliminating correlated variables is as follows:

```{r model.summary, echo=FALSE}
summary(model)
```

As we want to interpret the parameters of the model as odds ratios we calculate the exponential of each parameter. If the the result is greater than 1, this means that the parameter increases the odds of the occurrence of a fatality in the accident. If the result is less than 1, the parameter decreases the odds of a casualty in the accident.

```{r summarymodel, echo=FALSE}
sort(exp(model$coefficients))
```

With these results we focus on answering the Data Science questions:

  1. Which time and day of the week is more probable that an accident with fatalities occurs?
    
  The statistical analysis shows that the time of the day, the day of the week and the month of the year are all associated with the likelihood of fatal accidents. Specifically, compared to the Afternoon, Early morning and Evening have higher odds of fatal accidents by 1.63 and 1.28 times respectively. Similarly, compared to Mondays, Saturdays and Sundays have higher odds by 1.11 and 1.13 times respectively. Moreover, compared to January, July, August and September have the highest odds increases by 1.67, 1.59 and 1.47 times respectively. Therefore, a prevention campaign should target the summer months, the weekends and the early morning hours.
    
  2. What kind of weather condition is most prevalent during car accidents with fatalities?
    
  The C_WTHR variable has statistically significant effects on the likelihood of a fatal outcome in a crash. Compared to clear and sunny days, the odds of at least one fatal in an accident are 1.52 and 1.49 times higher when there is visibility limitation or strong wind, respectively. Conversely, the odds of a fatal crash are lower when the weather is overcast, rainy, or snowy, by factors of 0.91, 0.71, and 0.85 respectively. A useful campaign could educate drivers on how to cope with low visibility or high wind situations.
    
  3. Is there a correlation between the road configuration and the severity of the accident?
    
  Compared to non-intersection accidents, the odds of having at least one fatality are 0.46 times lower for intersection accidents, and 0.51 times lower for other road configurations such as bridges, tunnels or traffic circles. These results suggest that more traffic signals should be installed in non-intersection roads.
    
  4. Is there a correlation between the road alignment and the severity of the accident?
    
  The risk of a having at least one fatal is higher on curved roads than on straight flat ones. Curved leveled roads have a 1.46 times higher risk, while curved roads with gradient have a 1.62 times higher risk. Based on these findings and the previous ones on road configuration, we suggest launching a campaign to raise awareness of the dangers of these roads and to install more traffic signs on them.
    
  5. How does the safety device affect the likelihood of casualties in traffic accidents?
    
  The variable C_SAFE indicates how likely it is for someone to die in a crash when no safety device is used. The result is 5.02, which means the risk of death is more than five times higher without any safety device. This is a very alarming number, and it suggests that we need to promote the use of safety devices among drivers and passengers, and also make sure that companies follow the safety standards, as this factor has a great influence on the survival rate of an accident.
    
  6. When there is elderly and underage people involved in a car accident, is it more probable to have fatalities reported?
    
  The analysis shows that the presence of underage people reduces the odds of a fatal outcome by a factor of 0.70. However, this finding is puzzling, as there is no obvious reason why underage people would be safer in transportation. Therefore, the age criterion for defining underage people may need to be revised. Conversely, the presence of elderly people increases the odds of a fatal outcome by a factor of 1.60. This suggests that more attention and care should be given to elderly people when they use any mode of transportation.


Regarding how well the model fit the data, with a threshold of `r roc.coords$threshold` we obtained an accuracy of `r accuracy_lr`. But the sensitivity of the model is not very high, which can be related to the limitation of the logistic regression to capture non-linear relation between variables.
Regarding dimensionality reduction, we do not remove variables because all of them are categorical, but we applied shrinkage regression with an L1 regularization. With this method, the accuracy increases in 2 percentage points.
On the other hand, we applied KNN that with a K = `r top.k`, we obtained an accuracy of `r accuracy_knn`, similar to Logistic regression with L1 regularization. Also, it is possible to see an improvement in the sensitivity compare to the logistic regression. The main drawback of this model is that we can’t interpret the parameters.


# Conclusions

In this report, we have the aim to identify the factors that influence the likelihood and severity of car accidents. For this we applied a Logistic Regression and also a KNN. As the data set was severely imbalanced, we applied undersampling. By appliying Logistic regression, we conclude that the main variable that contributes to a casualty in a car accident is the use of Safety Device. In this line, the promotion of safety devices, as seat belts, child restrains, helmet, among other, is very important to decrease the number of casualties in car accidents. On the other hand, casualties in accidents mainly occur on low visibility or high wind conditions. The results also points at the weekends, early mornings and summer months as the ones with more odds of at least one fatality given that an accident has happened.

The accuracy of KNN (`r accuracy_knn`) was better than logistic regression (`r accuracy_lr`), and particularly it presents a better sensitivity. But the main advantage of Logistic regression is that we can deliver an interpretation of the variables, allowing us to identify the main factors behind car accidents with casualties and propose public policies to decrease them.




